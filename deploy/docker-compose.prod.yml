version: "3.8"

services:
  app:
    # ECR image reference is provided by CodeDeploy hook via ECR_IMAGE env var
    image: ${ECR_IMAGE}
    container_name: batch-kafka-app
    ports:
      - "8080:8080"
    mem_limit: 6g
    memswap_limit: 6g
    environment:
      # Spring 프로필 (파티션 3개 실험)
      SPRING_PROFILES_ACTIVE: prod,p3

      # JVM 메모리 제한 (t3.large 8GB 최적화 - 10만 트래픽 처리)
      # Heap 5GB (컨테이너 6GB 중 안전 마진 1GB 확보, Non-Heap 영역 보장)
      JAVA_TOOL_OPTIONS: -Xms2g -Xmx5g -XX:MaxMetaspaceSize=256m -XX:MaxDirectMemorySize=256m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled -Duser.timezone=Asia/Seoul -Dfile.encoding=UTF-8
    env_file:
      - /opt/batch-kafka/.env.prod
    restart: unless-stopped

